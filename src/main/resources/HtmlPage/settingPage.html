<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>类别顺序自定义</title>
    <style>
        #main {
            margin: 0 auto;
            width: 80%;
        }

        #itembox div {
            border: 1px solid gray;
            list-style: none;
            padding: 5px;
            margin: 5px;
            max-width: 50vw;
        }
    </style>
</head>

<body>
<div id="main">
    <p>勾选以下选项代表是否查询、拖拽选项进行顺序排序。</p>
    <div id="itembox">
    </div>
    <input type="button" value="提交设置" onclick="savingSetting()" style="margin: 0 auto;"></input>
</div>
<script>
    var dataClassInfo = ${javaDataReplace};
    function loadDataClass() {
        let res = '';
        let items = dataClassInfo.order;
        let index = 0;
        items.forEach(obj => {
            res += '<div draggable="true"><input  type="checkbox" id="di' + obj + '">' + (++index) + '、' + dataClassInfo.data_ch[obj] + '</input></div>'
        };
    )
        document.getElementById('itembox').innerHTML = res;

        dataClassInfo.select.forEach(se => {
            document.getElementById('di' + se).checked = true;
    })
    }
    function dragg() {
        var box = document.querySelector('#itembox').getElementsByTagName('div');
        var content = null;
        for (let i = 0; i < box.length; i++) {
            box[i].ondragstart = function () {
                content = this;
            };
            box[i].ondragover = function () {
                event.preventDefault();
            };
            box[i].ondrop = function () {
                if (content != null && content != this) {
                    var temp = document.createElement("div");
                    document.querySelector("#itembox").replaceChild(temp, this);
                    document.querySelector("#itembox").replaceChild(this, content);
                    document.querySelector("#itembox").replaceChild(content, temp);
                }
            }
        }
    }
    function savingSetting() {
        let newBox = document.querySelector('#itembox').getElementsByTagName('div');
        let newOrder = [], newSelect = [];
        for (let i = 0; i < newBox.length; i++) {
            let no = newBox[i].getElementsByTagName('input')[0];
            let sid = no.id.replace('di', '');
            let scheck = no.checked;
            newOrder.push(sid);
            if (scheck == true)
                newSelect.push(sid);

        }
        saveToLocalstorage(newOrder, newSelect)
    }

    function saveToLocalstorage(newOrder, newSelect) {
        dataClassInfo.select = newSelect;
        dataClassInfo.order = newOrder;
        var httpRequest = new XMLHttpRequest();
        let url = 'http://192.168.42.187:6868/fsettingUpload';
        httpRequest.open('POST', url, true);
        httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");/*设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）*/
        httpRequest.send('body=' + JSON.stringify(dataClassInfo));/*发送请求 将情头体写在send中*/
        httpRequest.onreadystatechange = function () {
            if (httpRequest.readyState == 4 && httpRequest.status == 200) {
                var json = httpRequest.responseText;/*获取到json字符串，还需解析*/
                if (json == 'FINISHED') alert('设置已保存。')
            }
        }
    }
    loadDataClass();
    dragg();
</script>
</body>

</html>